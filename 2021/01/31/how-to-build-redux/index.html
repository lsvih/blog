<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"lsvih.com","root":"/","images":"/images","scheme":"Pisces","version":"8.2.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"algolia":{"appID":"6U6P1RGK4F","apiKey":"b14e73cdd627eabe947b5decbe14850f","indexName":"lsvih","hits":{"per_page":10}}};
  </script>
<meta name="description" content="Redux 是一个简单的库，可以帮助你管理 JavaScript 应用的状态。虽然它很简单，但在学习过程中还是很容易掉坑。我经常需要解释 Redux 的用法和原理，而且我总是会从如何实现 Redux 来开始说明。所以，在此我们做这样一件事：从头开始，写一个能用的 Redux。我们的实现不会考虑所有的情况，但可以揭示大部分 Redux 的原理。 注意，实际上我们将会实现的是 Redux 和 Reac">
<meta property="og:type" content="article">
<meta property="og:title" content="自己写一个 Redux">
<meta property="og:url" content="https://lsvih.com/2021/01/31/how-to-build-redux/index.html">
<meta property="og:site_name" content="My note">
<meta property="og:description" content="Redux 是一个简单的库，可以帮助你管理 JavaScript 应用的状态。虽然它很简单，但在学习过程中还是很容易掉坑。我经常需要解释 Redux 的用法和原理，而且我总是会从如何实现 Redux 来开始说明。所以，在此我们做这样一件事：从头开始，写一个能用的 Redux。我们的实现不会考虑所有的情况，但可以揭示大部分 Redux 的原理。 注意，实际上我们将会实现的是 Redux 和 Reac">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-01-31T14:03:00.000Z">
<meta property="article:modified_time" content="2021-01-31T14:09:58.294Z">
<meta property="article:author" content="lsvih">
<meta property="article:tag" content="Translate">
<meta property="article:tag" content="juejin">
<meta property="article:tag" content="React">
<meta property="article:tag" content="Redux">
<meta property="article:tag" content="Frontend">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://lsvih.com/2021/01/31/how-to-build-redux/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>
<title>自己写一个 Redux | My note</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-142893470-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-142893470-1');
      }
    </script>




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="My note" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">My note</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">lsvih</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
        <li class="menu-item menu-item-about"><a href="https://cv.lsvih.com/" rel="noopener" target="_blank"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container">
  <div class="algolia-stats"><hr></div>
  <div class="algolia-hits"></div>
  <div class="algolia-pagination"></div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%B7%B1%E7%9A%84%E7%8A%B6%E6%80%81%E5%AF%B9%E8%B1%A1"><span class="nav-number">1.</span> <span class="nav-text">实现自己的状态对象</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E4%BD%95%E4%BD%BF%E7%94%A8-Redux%EF%BC%9F"><span class="nav-number">2.</span> <span class="nav-text">为何使用 Redux？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reducer"><span class="nav-number">3.</span> <span class="nav-text">Reducer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8D%E5%8F%AF%E5%8F%98%E6%80%A7"><span class="nav-number">3.1.</span> <span class="nav-text">不可变性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%88%91%E4%BB%AC%E7%9A%84-Reducer"><span class="nav-number">3.2.</span> <span class="nav-text">使用我们的 Reducer</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Store"><span class="nav-number">4.</span> <span class="nav-text">Store</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84%E7%BB%84%E4%BB%B6"><span class="nav-number">5.</span> <span class="nav-text">创建自己的组件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%8B%E5%8A%A8%E7%BB%84%E8%A3%85%E8%B5%B7%E6%9D%A5"><span class="nav-number">6.</span> <span class="nav-text">手动组装起来</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Provider-%E5%92%8C-Connect"><span class="nav-number">7.</span> <span class="nav-text">Provider 和 Connect</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E7%BB%84%E8%A3%85"><span class="nav-number">8.</span> <span class="nav-text">自动组装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="nav-number">9.</span> <span class="nav-text">中间件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%84%E8%A3%85%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="nav-number">10.</span> <span class="nav-text">组装中间件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Thunk-%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="nav-number">11.</span> <span class="nav-text">Thunk 中间件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Action-%E5%88%9B%E5%BB%BA%E5%99%A8"><span class="nav-number">12.</span> <span class="nav-text">Action 创建器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%B1%E8%BF%99%E6%A0%B7%EF%BC%81"><span class="nav-number">13.</span> <span class="nav-text">就这样！</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%81%97%E7%95%99%E4%BA%8B%E9%A1%B9"><span class="nav-number">14.</span> <span class="nav-text">遗留事项</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%A7%E8%83%BD"><span class="nav-number">14.1.</span> <span class="nav-text">性能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%BB%E7%BB%93%E7%8A%B6%E6%80%81"><span class="nav-number">14.2.</span> <span class="nav-text">冻结状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93"><span class="nav-number">14.3.</span> <span class="nav-text">服务端渲染</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Store-%E5%A2%9E%E5%BC%BA"><span class="nav-number">14.4.</span> <span class="nav-text">Store 增强</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95"><span class="nav-number">14.5.</span> <span class="nav-text">测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%92%E5%BA%8F"><span class="nav-number">14.6.</span> <span class="nav-text">排序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Action-%E5%88%9B%E5%BB%BA%E5%99%A8%E7%9A%84%E5%89%AF%E4%BD%9C%E7%94%A8"><span class="nav-number">14.7.</span> <span class="nav-text">Action 创建器的副作用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1"><span class="nav-number">14.8.</span> <span class="nav-text">路由</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E5%AE%83%E4%BA%8B%E9%A1%B9"><span class="nav-number">14.9.</span> <span class="nav-text">其它事项</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">lsvih</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">167</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">211</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/lsvih" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;lsvih" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:lsvih@qq.com" title="E-Mail → mailto:lsvih@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://lsvih.com/2021/01/31/how-to-build-redux/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="lsvih">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="My note">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          自己写一个 Redux
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-01-31 22:03:00" itemprop="dateCreated datePublished" datetime="2021-01-31T22:03:00+08:00">2021-01-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Translate/" itemprop="url" rel="index"><span itemprop="name">Translate</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>Redux 是一个简单的库，可以帮助你管理 JavaScript 应用的状态。虽然它很简单，但在学习过程中还是很容易掉坑。我经常需要解释 Redux 的用法和原理，而且我总是会从如何实现 Redux 来开始说明。所以，在此我们做这样一件事：从头开始，写一个能用的 Redux。我们的实现不会考虑所有的情况，但可以揭示大部分 Redux 的原理。</p>
<p>注意，实际上我们将会实现的是 <a target="_blank" rel="noopener" href="https://github.com/reactjs/redux?utm_source=zapier.com&amp;utm_medium=referral&amp;utm_campaign=zapier">Redux</a> <strong>和</strong> <a target="_blank" rel="noopener" href="https://github.com/reactjs/react-redux?utm_source=zapier.com&amp;utm_medium=referral&amp;utm_campaign=zapier">React Redux</a>。在这里，我们把 Redux 和著名的 UI 库 <a target="_blank" rel="noopener" href="https://facebook.github.io/react/">React</a> 相结合，而这正是在实际场景中最为常见的组合。哪怕你把 Redux 和其他东西组合，这里讲解的所有东西几乎也还是一样的。</p>
<p>我们开始吧！</p>
<a id="more"></a>
<h2 id="实现自己的状态对象"><a href="#实现自己的状态对象" class="headerlink" title="实现自己的状态对象"></a>实现自己的状态对象</h2><p>大多数应用都会从服务端获取状态。我们先从在本地创建状态开始实现（即使我们是从服务端获取状态，也要先用一些状态来初始化应用）。我们将构建一个简单的笔记本应用，这样可以不用再去做千篇一律的 TODO 应用，而后文也可以看到，做这个笔记本应用也会驱使我们做一些有趣的东西来控制状态。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> initialState = &#123;</span><br><span class="line">  nextNoteId: <span class="number">1</span>,</span><br><span class="line">  notes: &#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>首先，注意我们的数据只是一个简单的 JS 对象。Redux 会帮助我们<strong>管理状态的改变</strong>，但它并不太关心状态本身。</p>
<h2 id="为何使用-Redux？"><a href="#为何使用-Redux？" class="headerlink" title="为何使用 Redux？"></a>为何使用 Redux？</h2><p>在我们继续深入之前，首先来看看不使用 Redux 要怎样开发我们创建的应用。首先，我们需要把 <code>initialState</code> 对象绑定到 <code>window</code> 上，像这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.state = initialState;</span><br></pre></td></tr></table></figure>
<p>这就是我们的 store！现在我们不需要什么 Redux，直接来构建一个新的笔记组件吧：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> onAddNote = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> id = <span class="built_in">window</span>.state.nextNoteId;</span><br><span class="line">  <span class="built_in">window</span>.state.notes[id] = &#123;</span><br><span class="line">    id,</span><br><span class="line">    content: <span class="string">&#x27;&#x27;</span></span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="built_in">window</span>.state.nextNoteId++;</span><br><span class="line">  renderApp();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> NoteApp = <span class="function">(<span class="params">&#123;notes&#125;</span>) =&gt;</span> (</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;ul className=<span class="string">&quot;note-list&quot;</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">Object</span>.keys(notes).map(<span class="function"><span class="params">id</span> =&gt;</span> (</span><br><span class="line">        <span class="comment">// Obviously we should render something more interesting than the id.</span></span><br><span class="line">        &lt;li className=<span class="string">&quot;note-list-item&quot;</span> key=&#123;id&#125;&gt;&#123;id&#125;&lt;/li&gt;</span><br><span class="line">      ))</span><br><span class="line">    &#125;</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line">    &lt;button className=<span class="string">&quot;editor-button&quot;</span> onClick=&#123;onAddNote&#125;&gt;New Note&lt;/button&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> renderApp = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  ReactDOM.render(</span><br><span class="line">    &lt;NoteApp notes=&#123;<span class="built_in">window</span>.state.notes&#125;/&gt;,</span><br><span class="line">    <span class="built_in">document</span>.getElementById(<span class="string">&#x27;root&#x27;</span>)</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">renderApp();</span><br></pre></td></tr></table></figure>
<p>你可以在 <a target="_blank" rel="noopener" href="https://jsfiddle.net/justindeal/5j3can1z/102/">JSFiddle</a> 尝试这个例子。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> initialState = &#123;</span><br><span class="line">  nextNoteId: <span class="number">1</span>,</span><br><span class="line">  notes: &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.state = initialState;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> onAddNote = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> id = <span class="built_in">window</span>.state.nextNoteId;</span><br><span class="line">  <span class="built_in">window</span>.state.notes[id] = &#123;</span><br><span class="line">    id,</span><br><span class="line">    content: <span class="string">&#x27;&#x27;</span></span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="built_in">window</span>.state.nextNoteId++;</span><br><span class="line">  renderApp();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> NoteApp = <span class="function">(<span class="params">&#123;notes&#125;</span>) =&gt;</span> (</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;ul className=<span class="string">&quot;note-list&quot;</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">Object</span>.keys(notes).map(<span class="function"><span class="params">id</span> =&gt;</span> (</span><br><span class="line">        <span class="comment">// 显然我们需要显示一些比 id 更有趣的东西。</span></span><br><span class="line">        &lt;li className=<span class="string">&quot;note-list-item&quot;</span> key=&#123;id&#125;&gt;&#123;id&#125;&lt;/li&gt;</span><br><span class="line">      ))</span><br><span class="line">    &#125;</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line">    &lt;button className=<span class="string">&quot;editor-button&quot;</span> onClick=&#123;onAddNote&#125;&gt;New Note&lt;/button&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> renderApp = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  ReactDOM.render(</span><br><span class="line">    &lt;NoteApp notes=&#123;<span class="built_in">window</span>.state.notes&#125;/&gt;,</span><br><span class="line">    <span class="built_in">document</span>.getElementById(<span class="string">&#x27;root&#x27;</span>)</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">renderApp();</span><br></pre></td></tr></table></figure>
<p>虽然这不是一个很实用的应用，但它能正常工作。看起来我们已经证明了不用 Redux 也能做出记事本，所以这篇文章已经完结了~</p>
<p>并没有…</p>
<p>让我们展望一下：我们之后加入了一些新的特性，开发了一个很好的服务端，成立了一个公司来销售它，得到了大量用户，然后又添加了大量的新特性，赚了些钱，扩大公司……（想太多了）</p>
<p>（在这个简单的记事本应用中很难看出来）在我们通向成功的道路上，这个应用可能不断的增大，包含数百个文件中的数百个组件。我们的应用会执行异步操作，所以我们将会有这样的代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> onAddNote = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">window</span>.state.onLoading = <span class="literal">true</span>;</span><br><span class="line">  renderApp();</span><br><span class="line">  api.createNote()</span><br><span class="line">    .then(<span class="function">(<span class="params">note</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">window</span>.state.onLoading = <span class="literal">false</span>;</span><br><span class="line">      <span class="built_in">window</span>.state.notes[id] = note;</span><br><span class="line">      renderApp();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>也会有这样的 bug：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ARCHIVE_TAG_ID = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> onAddTag = <span class="function">(<span class="params">noteId, tagId</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">window</span>.state.onLoading = <span class="literal">true</span>;</span><br><span class="line">  <span class="comment">// 哎呀，这里忘记渲染了！</span></span><br><span class="line">  <span class="comment">// 使用速度快的本地服务器时，我们可能不会发现。</span></span><br><span class="line">  api.addTag(noteId, tagId)</span><br><span class="line">    .then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">window</span>.state.onLoading = <span class="literal">false</span>;</span><br><span class="line">      <span class="built_in">window</span>.state.tagMapping[tagId] = noteId;</span><br><span class="line">      <span class="keyword">if</span> (ARCHIVE_TAG_ID) &#123;</span><br><span class="line">        <span class="comment">// 哎呀，一些命名 bug。可能是由于粗暴的搜索/替换产生的。直到我们测试这个没人真正使用的档案页面时，我们才会发现。</span></span><br><span class="line">        <span class="built_in">window</span>.state.archived = <span class="built_in">window</span>.state.archive || &#123;&#125;;</span><br><span class="line">        <span class="built_in">window</span>.state.archived[noteId] = <span class="built_in">window</span>.state.notes[noteId];</span><br><span class="line">        <span class="keyword">delete</span> <span class="built_in">window</span>.state.notes[noteId];</span><br><span class="line">      &#125;</span><br><span class="line">      renderApp();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>以及一些奇奇怪怪、临时的状态改变，几乎没人知道它们是做什么的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> SomeEvilComponent = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  &lt;button onClick=&#123;<span class="function">() =&gt;</span> <span class="built_in">window</span>.state.pureEvil = <span class="literal">true</span>&#125;&gt;Do Evil&lt;/button&gt;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在很长一段时间内，很多开发者在大型代码库中共同添加代码，我们将会遇到一系列的问题：</p>
<ol>
<li>渲染可能在任何地方触发。将会有奇怪的 UI 卡顿或卡死，而且看起来似乎是随机的。</li>
<li>潜在的竞态条件，甚至在我们看到的少量代码里就存在。</li>
<li>状态太混乱几乎不能进行测试。你必须让<strong>整个</strong>应用处于特定状态，然后不断调试状态，看看<strong>整个</strong>应用的状态是否如你所料。</li>
<li>如果你发现一个 bug，你可以有根据地猜测去哪修复，但最终，你的应用中的每一行代码都有嫌疑。</li>
</ol>
<p>最后一点是最糟糕的问题，也是我们选择 Redux 的主要原因。如果你想要降低整个应用的复杂性，最好（我个人的观点）通过限制如何、以及在哪里可以改变应用的状态。Redux 不是解决其它问题的灵丹妙药，但是这些限制会让问题出现更少。</p>
<h2 id="Reducer"><a href="#Reducer" class="headerlink" title="Reducer"></a>Reducer</h2><p>所以 Redux 是怎样提供这些限制并帮助你管理状态的呢？从一个输入当前状态并返回新状态的简单函数开始说明。对于我们的笔记本应用，如果我们提供一个添加笔记的动作，应当得到一个添加新笔记后的状态：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> CREATE_NOTE = <span class="string">&#x27;CREATE_NOTE&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> UPDATE_NOTE = <span class="string">&#x27;UPDATE_NOTE&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> reducer = <span class="function">(<span class="params">state = initialState, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> CREATE_NOTE:</span><br><span class="line">      <span class="keyword">return</span> <span class="comment">// 有新笔记的状态</span></span><br><span class="line">    <span class="keyword">case</span> UPDATE_NOTE:</span><br><span class="line">      <span class="keyword">return</span> <span class="comment">// 更新笔记之后的状态</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>如果你不爽 <code>switch</code> 语句，也可以用其他方式写 reducer。我经常使用一个对象，并让 key 指向每种类型的 handler，像这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> handlers = &#123;</span><br><span class="line">  [CREATE_NOTE]: <span class="function">(<span class="params">state, action</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="comment">// 新笔记的新状态</span></span><br><span class="line">  &#125;,</span><br><span class="line">  [UPDATE_NOTE]: <span class="function">(<span class="params">state, action</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="comment">// 修改笔记后的新状态</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> reducer = <span class="function">(<span class="params">state = initialState, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (handlers[action.type]) &#123;</span><br><span class="line">    <span class="keyword">return</span> handlers[action.type](state, action);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> state;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>写法并不重要。reducer 是你自己写的函数，可以用任何方式来实现它。Redux 完全不关心你怎么做的。</p>
<h3 id="不可变性"><a href="#不可变性" class="headerlink" title="不可变性"></a>不可变性</h3><p>Redux 关心的是，你的 reducer 必须是<strong>纯函数</strong>。意味着你绝对不能这样写：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> reducer = <span class="function">(<span class="params">state = initialState, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> CREATE_NOTE: &#123;</span><br><span class="line">      <span class="comment">// 不要这样改变状态!!!</span></span><br><span class="line">      state.notes[state.nextNoteId] = &#123;</span><br><span class="line">        id: state.nextNoteId,</span><br><span class="line">        content: <span class="string">&#x27;&#x27;</span></span><br><span class="line">      &#125;;</span><br><span class="line">      state.nextNoteId++;</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> UPDATE_NOTE: &#123;</span><br><span class="line">      <span class="comment">// 不要这样改变状态!!!</span></span><br><span class="line">      state.notes[action.id].content = action.content;</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>实际上，如果你像这样改变状态，Redux 将不会正常工作。因为虽然你在改变状态，但是对象的引用不会改变（组件绑定的状态是绑定对象的引用），所以你的应用将不会正确地更新。也会导致不能使用一些 Redux 开发者工具，因为这些工具跟踪的是先前的状态。如果你在持续性地修改状态，将不能进行状态回退。</p>
<p>原则上，修改状态使得组建自己的 reducer（也可能包括应用的其他部分）更困难。纯函数是可预测的，因为他们在同样的输入下会产生同样的输出。如果你养成了修改状态的习惯，一切就都完了。函数调用变得不确定。你必须在头脑中记住整棵函数调用树。</p>
<p>这种可预测性的代价很高，尤其是因为 JavaScript 原生不支持不可变对象。在本文的例子中，我们将使用原生 JavaScript，需要多写一些冗余的代码。以下是我们写 reducer 的正确方式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> reducer = <span class="function">(<span class="params">state = initialState, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> CREATE_NOTE: &#123;</span><br><span class="line">      <span class="keyword">const</span> id = state.nextNoteId;</span><br><span class="line">      <span class="keyword">const</span> newNote = &#123;</span><br><span class="line">        id,</span><br><span class="line">        content: <span class="string">&#x27;&#x27;</span></span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        nextNoteId: id + <span class="number">1</span>,</span><br><span class="line">        notes: &#123;</span><br><span class="line">          ...state.notes,</span><br><span class="line">          [id]: newNote</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> UPDATE_NOTE: &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123;id, content&#125; = action;</span><br><span class="line">      <span class="keyword">const</span> editedNote = &#123;</span><br><span class="line">        ...state.notes[id],</span><br><span class="line">        content</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        notes: &#123;</span><br><span class="line">          ...state.notes,</span><br><span class="line">          [id]: editedNote</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我在使用<a target="_blank" rel="noopener" href="https://github.com/tc39/proposal-object-rest-spread?utm_source=zapier.com&amp;utm_medium=referral&amp;utm_campaign=zapier">对象扩展语法</a>（<code>...</code>）。如果你想使用较传统的 JavaScript 语法，可以使用 <code>Object.assign</code>。理念都是一样的：不要改变状态，而是为任何状态、嵌套对象、数组创建浅拷贝。对于任何不变的对象，我们只引用存在的部分。我们再仔细看一下这部分代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  ...state,</span><br><span class="line">  notes: &#123;</span><br><span class="line">    ...state.notes,</span><br><span class="line">    [id]: editedNote</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我们只改变 <code>notes</code> 属性，而 <code>state</code> 属性将保持不变。<code>...state</code> 的含义是，复用已经存在的属性。类似地，在 <code>notes</code> 中，我们只改变我们正在编辑的部分，<code>...state.notes</code> 中的其他部分将不会改变。这样，我们可以借助 <a target="_blank" rel="noopener" href="https://reactjs.org/docs/react-component.html#shouldcomponentupdate"><code>shouldComponentUpdate</code></a> 或 <a target="_blank" rel="noopener" href="https://reactjs.org/docs/react-api.html#reactpurecomponent"><code>PureComponent</code></a>，使得有未改变的 note 作为 props 的组件避免重复渲染。记住，我们还需要避免像这样写 reducer：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> reducer = <span class="function">(<span class="params">state = initialState, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 好了，我们避免了修改，但是……千万别这样做！</span></span><br><span class="line">  state = _.cloneDeep(state)</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">case</span> UPDATE_NOTE: &#123;</span><br><span class="line">      <span class="comment">// 现在可以做些改变了</span></span><br><span class="line">      state.notes[action.id].content = action.content;</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>你又得到了简练的修改对象的代码，而且<strong>实际上</strong> Redux 可以在这种情况下正常工作，但是将无法进行优化。每个对象和数组在每次状态改变时都会是全新的，所以任何依赖于这些对象和数组的组件都将会重新渲染，哪怕你实际上没有对这些组件的状态做任何修改。</p>
<p>我们不可变的 reducer 肯定需要更多的类型定义，也会有更高的学习成本。但以后，你将会为改变状态的函数是独立的，而且容易测试而感到高兴。对于一个真实的应用，你<strong>可能</strong>想要看一下像 <a target="_blank" rel="noopener" href="https://github.com/lodash/lodash/wiki/FP-Guide?utm_source=zapier.com&amp;utm_medium=referral&amp;utm_campaign=zapier">lodash-fp</a>，或 <a target="_blank" rel="noopener" href="http://ramdajs.com/">Ramda</a> 或 <a target="_blank" rel="noopener" href="https://facebook.github.io/immutable-js/">Immutable.js</a>。在这里，我们使用 <a target="_blank" rel="noopener" href="https://github.com/kolodny/immutability-helper?utm_source=zapier.com&amp;utm_medium=referral&amp;utm_campaign=zapier">immutability-helper</a> 的一个变种，它很简单。提醒一下，这里有很大的坑，我甚至为此写了<a target="_blank" rel="noopener" href="https://github.com/jdeal/qim?utm_source=zapier.com&amp;utm_medium=referral&amp;utm_campaign=zapier">一个新的库</a>。原生的 JS 也很不错，而且有很好且强壮的类型定义解决方案，如 <a target="_blank" rel="noopener" href="https://flow.org/">Flow</a> 和 <a target="_blank" rel="noopener" href="https://www.typescriptlang.org/">TypeScript</a>。确保使用较小粒度的函数，就像你使用 React 时的情况一样：虽然总体上会比 jQuery 使用更多代码，但是每个组件都更容易预测。</p>
<h3 id="使用我们的-Reducer"><a href="#使用我们的-Reducer" class="headerlink" title="使用我们的 Reducer"></a>使用我们的 Reducer</h3><p>我们来把一个 action 接入我们的 reducer，并生成一个新的 state。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> state0 = reducer(<span class="literal">undefined</span>, &#123;</span><br><span class="line">  type: CREATE_NOTE</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>现在 <code>state0</code> 看起来像这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  nextNoteId: <span class="number">2</span>,</span><br><span class="line">  notes: &#123;</span><br><span class="line">    <span class="number">1</span>: &#123;</span><br><span class="line">      id: <span class="number">1</span>,</span><br><span class="line">      content: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意，我们把 <code>undefined</code> 作为状态的输入。Redux 总是传入 <code>undefined</code> 作为初始状态，而且你一般需要使用 <code>state = initialState</code> 这样的方式来选择初始状态对象。下一次， Redux 将会输入先前的状态。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> state1  = reducer(state0, &#123;</span><br><span class="line">  type: UPDATE_NOTE,</span><br><span class="line">  id: <span class="number">1</span>,</span><br><span class="line">  content: <span class="string">&#x27;Hello, world!&#x27;</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>现在 <code>state1</code> 看起来像这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  nextNoteId: <span class="number">2</span>,</span><br><span class="line">  notes: &#123;</span><br><span class="line">    <span class="number">1</span>: &#123;</span><br><span class="line">      id: <span class="number">1</span>,</span><br><span class="line">      content: <span class="string">&#x27;Hello, world!&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>你可以在这里使用我们的 reducer<a target="_blank" rel="noopener" href="https://jsfiddle.net/justindeal/kLkjt4y3/37/">（代码链接）</a>：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> CREATE_NOTE = <span class="string">&#x27;CREATE_NOTE&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> UPDATE_NOTE = <span class="string">&#x27;UPDATE_NOTE&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> initialState = &#123;</span><br><span class="line">  nextNoteId: <span class="number">1</span>,</span><br><span class="line">  notes: &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> reducer = <span class="function">(<span class="params">state = initialState, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> CREATE_NOTE: &#123;</span><br><span class="line">      <span class="keyword">const</span> id = state.nextNoteId;</span><br><span class="line">      <span class="keyword">const</span> newNote = &#123;</span><br><span class="line">        id,</span><br><span class="line">        content: <span class="string">&#x27;&#x27;</span></span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        nextNoteId: id + <span class="number">1</span>,</span><br><span class="line">        notes: &#123;</span><br><span class="line">          ...state.notes,</span><br><span class="line">          [id]: newNote</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> UPDATE_NOTE: &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123;id, content&#125; = action;</span><br><span class="line">      <span class="keyword">const</span> editedNote = &#123;</span><br><span class="line">        ...state.notes[id],</span><br><span class="line">        content</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        notes: &#123;</span><br><span class="line">          ...state.notes,</span><br><span class="line">          [id]: editedNote</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> state0 = reducer(<span class="literal">undefined</span>, &#123;</span><br><span class="line">  type: CREATE_NOTE</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> state1  = reducer(state0, &#123;</span><br><span class="line">  type: UPDATE_NOTE,</span><br><span class="line">  id: <span class="number">1</span>,</span><br><span class="line">  content: <span class="string">&#x27;Hello, world!&#x27;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">  &lt;pre&gt;&#123;<span class="built_in">JSON</span>.stringify(state1, <span class="literal">null</span>, <span class="number">2</span>)&#125;&lt;/pre&gt;,</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">&#x27;root&#x27;</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>当然，Redux 并不会像这样创建更多的变量，但我们将会很快讲到真正的实现。重点是，Redux 的核心只是你写的一小块代码，一个简单地接收上一个状态，并返回下一个状态的函数。为什么这个函数被叫做 reducer？因为它可以被接入标准的 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/Reduce"><code>reduce</code></a> 函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> actions = [</span><br><span class="line">  &#123;<span class="attr">type</span>: CREATE_NOTE&#125;,</span><br><span class="line">  &#123;<span class="attr">type</span>: UPDATE_NOTE, <span class="attr">id</span>: <span class="number">1</span>, <span class="attr">content</span>: <span class="string">&#x27;Hello, world!&#x27;</span>&#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> state = actions.reduce(reducer, <span class="literal">undefined</span>);</span><br></pre></td></tr></table></figure>
<p>然后，<code>state</code> 将会看起来和之前的 <code>state1</code> 一样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  nextNoteId: <span class="number">2</span>,</span><br><span class="line">  notes: &#123;</span><br><span class="line">    <span class="number">1</span>: &#123;</span><br><span class="line">      id: <span class="number">1</span>,</span><br><span class="line">      content: <span class="string">&#x27;Hello, world!&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>你可以在这里向我们的 <code>actions</code> 数组添加元素，并输入给 reducer<a target="_blank" rel="noopener" href="https://jsfiddle.net/justindeal/edogdh33/13/">（代码链接）</a>：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> CREATE_NOTE = <span class="string">&#x27;CREATE_NOTE&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> UPDATE_NOTE = <span class="string">&#x27;UPDATE_NOTE&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> initialState = &#123;</span><br><span class="line">  nextNoteId: <span class="number">1</span>,</span><br><span class="line">  notes: &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> reducer = <span class="function">(<span class="params">state = initialState, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> CREATE_NOTE: &#123;</span><br><span class="line">      <span class="keyword">const</span> id = state.nextNoteId;</span><br><span class="line">      <span class="keyword">const</span> newNote = &#123;</span><br><span class="line">        id,</span><br><span class="line">        content: <span class="string">&#x27;&#x27;</span></span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        nextNoteId: id + <span class="number">1</span>,</span><br><span class="line">        notes: &#123;</span><br><span class="line">          ...state.notes,</span><br><span class="line">          [id]: newNote</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> UPDATE_NOTE: &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123;id, content&#125; = action;</span><br><span class="line">      <span class="keyword">const</span> editedNote = &#123;</span><br><span class="line">        ...state.notes[id],</span><br><span class="line">        content</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        notes: &#123;</span><br><span class="line">          ...state.notes,</span><br><span class="line">          [id]: editedNote</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> actions = [</span><br><span class="line">  &#123;<span class="attr">type</span>: CREATE_NOTE&#125;,</span><br><span class="line">  &#123;<span class="attr">type</span>: UPDATE_NOTE, <span class="attr">id</span>: <span class="number">1</span>, <span class="attr">content</span>: <span class="string">&#x27;Hello, world!&#x27;</span>&#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> state = actions.reduce(reducer, <span class="literal">undefined</span>);</span><br><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">  &lt;pre&gt;&#123;<span class="built_in">JSON</span>.stringify(state, <span class="literal">null</span>, <span class="number">2</span>)&#125;&lt;/pre&gt;,</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">&#x27;root&#x27;</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>现在，你可以理解为什么 Redux 自称为“一个可预测的 JavaScript 应用状态容器”。输入一系列相同的 action，你将得到相同的状态。函数式编程必胜！如果你听说过 Redux 可以复现之前的状态，这就是大致的原理。实际上，Redux 并不会引用一个 action 列表，而是会使用一个变量指向状态对象，然后不断改变这个变量指向下一个状态的对象。这是在你的应用中允许的一个重要的改变（mutation），但是我们需要把这种改变控制在 store 中。</p>
<h2 id="Store"><a href="#Store" class="headerlink" title="Store"></a>Store</h2><p>我们来创建一个 store 吧。它可以保存我们单个的状态变量，并提供一些存取状态的方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> validateAction = <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!action || <span class="keyword">typeof</span> action !== <span class="string">&#x27;object&#x27;</span> || <span class="built_in">Array</span>.isArray(action)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;Action must be an object!&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> action.type === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;Action must have a type!&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> createStore = <span class="function">(<span class="params">reducer</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> state = <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    dispatch: <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">      validateAction(action)</span><br><span class="line">      state = reducer(state, action);</span><br><span class="line">    &#125;,</span><br><span class="line">    getState: <span class="function">() =&gt;</span> state</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>现在你可以看到，我们为什么使用常量而不是字符串。我们对于 action 的检测比 Redux 更宽松，但也足以保证我们不拼错 action 类型。如果我们传入字符串，action 将会直接进入 reducer 的默认分支（switch 的 default），什么都不会发生，错误可能会被忽视。但如果我们使用常量，拼写错误将会导致返回 <code>undefined</code> 并抛出错误，让我们立刻发现错误并修复它。</p>
<p>我们来创建一个 store 并且使用吧：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Pass in the reducer we made earlier.</span></span><br><span class="line"><span class="keyword">const</span> store = createStore(reducer);</span><br><span class="line"></span><br><span class="line">store.dispatch(&#123;</span><br><span class="line">  type: CREATE_NOTE</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">store.getState();</span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//   nextNoteId: 2,</span></span><br><span class="line"><span class="comment">//   notes: &#123;</span></span><br><span class="line"><span class="comment">//     1: &#123;</span></span><br><span class="line"><span class="comment">//       id: 1,</span></span><br><span class="line"><span class="comment">//       content: &#x27;&#x27;</span></span><br><span class="line"><span class="comment">//     &#125;</span></span><br><span class="line"><span class="comment">//   &#125;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure>
<p>现在已经可以使用了。我们有了一个 store，它可以使用任何我们提供的 reducer 来管理状态。但是还缺少一个重要的部分：一种订阅状态改变的方法。没有这种方法，我们就需要用一些笨拙的命令式代码。如果将来我们引入了异步 actions，它就完全不能用了。所以我们来实现订阅吧：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> createStore = <span class="function"><span class="params">reducer</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> state;</span><br><span class="line">  <span class="keyword">const</span> subscribers = [];</span><br><span class="line">  <span class="keyword">const</span> store = &#123;</span><br><span class="line">    dispatch: <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">      validateAction(action);</span><br><span class="line">      state = reducer(state, action);</span><br><span class="line">      subscribers.forEach(<span class="function"><span class="params">handler</span> =&gt;</span> handler());</span><br><span class="line">    &#125;,</span><br><span class="line">    getState: <span class="function">() =&gt;</span> state,</span><br><span class="line">    subscribe: <span class="function"><span class="params">handler</span> =&gt;</span> &#123;</span><br><span class="line">      subscribers.push(handler);</span><br><span class="line">      <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> index = subscribers.indexOf(handler);</span><br><span class="line">        <span class="keyword">if</span> (index &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          subscribers.splice(index, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  store.dispatch(&#123;<span class="attr">type</span>: <span class="string">&#x27;@@redux/INIT&#x27;</span>&#125;);</span><br><span class="line">  <span class="keyword">return</span> store;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这是一点点额外的并不<strong>太</strong>难理解的代码。其中的 <code>subscribe</code> 函数接收一个 <code>handler</code> 函数并把它添加到 <code>subscribers</code> 列表中。它还会返回一个用于取消订阅的函数。任何时候我们调用了 <code>dispatch</code>，我们就通知所有这些 handler。现在每次状态改变时，重新渲染就很简单了。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///////////////////////////////</span></span><br><span class="line"><span class="comment">// Mini Redux implementation //</span></span><br><span class="line"><span class="comment">///////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> validateAction = <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!action || <span class="keyword">typeof</span> action !== <span class="string">&#x27;object&#x27;</span> || <span class="built_in">Array</span>.isArray(action)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;Action must be an object!&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> action.type === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;Action must have a type!&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> createStore = <span class="function"><span class="params">reducer</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> state;</span><br><span class="line">  <span class="keyword">const</span> subscribers = [];</span><br><span class="line">  <span class="keyword">const</span> store = &#123;</span><br><span class="line">    dispatch: <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">      validateAction(action);</span><br><span class="line">      state = reducer(state, action);</span><br><span class="line">      subscribers.forEach(<span class="function"><span class="params">handler</span> =&gt;</span> handler());</span><br><span class="line">    &#125;,</span><br><span class="line">    getState: <span class="function">() =&gt;</span> state,</span><br><span class="line">    subscribe: <span class="function"><span class="params">handler</span> =&gt;</span> &#123;</span><br><span class="line">      subscribers.push(handler);</span><br><span class="line">      <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> index = subscribers.indexOf(handler);</span><br><span class="line">        <span class="keyword">if</span> (index &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          subscribers.splice(index, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  store.dispatch(&#123;<span class="attr">type</span>: <span class="string">&#x27;@@redux/INIT&#x27;</span>&#125;);</span><br><span class="line">  <span class="keyword">return</span> store;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////</span></span><br><span class="line"><span class="comment">// Our action types //</span></span><br><span class="line"><span class="comment">//////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> CREATE_NOTE = <span class="string">&#x27;CREATE_NOTE&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> UPDATE_NOTE = <span class="string">&#x27;UPDATE_NOTE&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/////////////////</span></span><br><span class="line"><span class="comment">// Our reducer //</span></span><br><span class="line"><span class="comment">/////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> initialState = &#123;</span><br><span class="line">  nextNoteId: <span class="number">1</span>,</span><br><span class="line">  notes: &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> reducer = <span class="function">(<span class="params">state = initialState, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> CREATE_NOTE: &#123;</span><br><span class="line">      <span class="keyword">const</span> id = state.nextNoteId;</span><br><span class="line">      <span class="keyword">const</span> newNote = &#123;</span><br><span class="line">        id,</span><br><span class="line">        content: <span class="string">&#x27;&#x27;</span></span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        nextNoteId: id + <span class="number">1</span>,</span><br><span class="line">        notes: &#123;</span><br><span class="line">          ...state.notes,</span><br><span class="line">          [id]: newNote</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> UPDATE_NOTE: &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123;id, content&#125; = action;</span><br><span class="line">      <span class="keyword">const</span> editedNote = &#123;</span><br><span class="line">        ...state.notes[id],</span><br><span class="line">        content</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        notes: &#123;</span><br><span class="line">          ...state.notes,</span><br><span class="line">          [id]: editedNote</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">///////////////</span></span><br><span class="line"><span class="comment">// Our store //</span></span><br><span class="line"><span class="comment">///////////////</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = createStore(reducer);</span><br><span class="line"></span><br><span class="line"><span class="comment">///////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// Render our app whenever the store changes //</span></span><br><span class="line"><span class="comment">///////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">store.subscribe(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  ReactDOM.render(</span><br><span class="line">    &lt;pre&gt;&#123;<span class="built_in">JSON</span>.stringify(store.getState(), <span class="literal">null</span>, <span class="number">2</span>)&#125;&lt;/pre&gt;,</span><br><span class="line">    <span class="built_in">document</span>.getElementById(<span class="string">&#x27;root&#x27;</span>)</span><br><span class="line">  );</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////</span></span><br><span class="line"><span class="comment">// Dispatch actions //</span></span><br><span class="line"><span class="comment">//////////////////////</span></span><br><span class="line"></span><br><span class="line">store.dispatch(&#123;</span><br><span class="line">  type: CREATE_NOTE</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">store.dispatch(&#123;</span><br><span class="line">  type: UPDATE_NOTE,</span><br><span class="line">  id: <span class="number">1</span>,</span><br><span class="line">  content: <span class="string">&#x27;Hello, world!&#x27;</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>可以在 <a target="_blank" rel="noopener" href="https://jsfiddle.net/justindeal/8cpu4ydj/27/">JSFiddle</a> 中尝试这些代码，并发出更多的 action。渲染的 HTML 将总是反映 store 状态。当然，对于真正的应用，我们将会把 <code>dispatch</code> 函数和用户的 action 联系起来。我们将会很快讲到这部分。</p>
<h2 id="创建自己的组件"><a href="#创建自己的组件" class="headerlink" title="创建自己的组件"></a>创建自己的组件</h2><p>如何写出可以和 Redux 配合使用的组件呢？只用简单的接收 props 的 React 组件就行了。你实现了你自己的状态，所以写的组件能和这些状态（至少是一部分状态）配合就可以了。有一些特殊情况<strong>可能会</strong>影响你的组件设计（特别是涉及到性能问题的时候），但是在大多数情况，简单的组件都不会有问题。我们从最简单的组件开始开发我们的应用吧：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> NoteEditor = <span class="function">(<span class="params">&#123;note, onChangeNote, onCloseNote&#125;</span>) =&gt;</span> (</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;textarea</span><br><span class="line">        className=<span class="string">&quot;editor-content&quot;</span></span><br><span class="line">        autoFocus</span><br><span class="line">        value=&#123;note.content&#125;</span><br><span class="line">        onChange=&#123;<span class="function"><span class="params">event</span> =&gt;</span> onChangeNote(note.id, event.target.value)&#125;</span><br><span class="line">        rows=&#123;<span class="number">10</span>&#125; cols=&#123;<span class="number">80</span>&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;button className=<span class="string">&quot;editor-button&quot;</span> onClick=&#123;onCloseNote&#125;&gt;Close&lt;/button&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> NoteTitle = <span class="function">(<span class="params">&#123;note&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> title = note.content.split(<span class="string">&#x27;\n&#x27;</span>)[<span class="number">0</span>].replace(<span class="regexp">/^\s+|\s+$/g</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">  <span class="keyword">if</span> (title === <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">i</span>&gt;</span>Untitled<span class="tag">&lt;/<span class="name">i</span>&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;title&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> NoteLink = <span class="function">(<span class="params">&#123;note, onOpenNote&#125;</span>) =&gt;</span> (</span><br><span class="line">  &lt;li className=<span class="string">&quot;note-list-item&quot;</span>&gt;</span><br><span class="line">    &lt;a href=<span class="string">&quot;#&quot;</span> onClick=&#123;<span class="function">() =&gt;</span> onOpenNote(note.id)&#125;&gt;</span><br><span class="line">      &lt;NoteTitle note=&#123;note&#125;/&gt;</span><br><span class="line">    &lt;/a&gt;</span><br><span class="line">  &lt;/li&gt;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> NoteList = <span class="function">(<span class="params">&#123;notes, onOpenNote&#125;</span>) =&gt;</span> (</span><br><span class="line">  &lt;ul className=<span class="string">&quot;note-list&quot;</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">Object</span>.keys(notes).map(<span class="function"><span class="params">id</span> =&gt;</span></span><br><span class="line">        &lt;NoteLink</span><br><span class="line">          key=&#123;id&#125;</span><br><span class="line">          note=&#123;notes[id]&#125;</span><br><span class="line">          onOpenNote=&#123;onOpenNote&#125;</span><br><span class="line">        /&gt;</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &lt;/ul&gt;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> NoteApp = (&#123;</span><br><span class="line">  notes, openNoteId, onAddNote, onChangeNote,</span><br><span class="line">  onOpenNote, onCloseNote</span><br><span class="line">&#125;) =&gt; (</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &#123;</span><br><span class="line">      openNoteId ?</span><br><span class="line">        &lt;NoteEditor</span><br><span class="line">          note=&#123;notes[openNoteId]&#125; onChangeNote=&#123;onChangeNote&#125;</span><br><span class="line">          onCloseNote=&#123;onCloseNote&#125;</span><br><span class="line">        /&gt; :</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">          &lt;NoteList notes=&#123;notes&#125; onOpenNote=&#123;onOpenNote&#125;/&gt;</span><br><span class="line">          &lt;button className=<span class="string">&quot;editor-button&quot;</span> onClick=&#123;onAddNote&#125;&gt;New Note&lt;/button&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &#125;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>没什么特别的。我们可以把 props 输入给这些组件，并且渲染它们。但是需要注意传入的 <code>openNoteId</code> 属性以及 <code>onOpenNote</code> 和 <code>onCloseNote</code> 的回调：我们需要决定状态和回调存放在哪里。我们可以直接使用组件的 state，这当然没问题。但当你开始使用 Redux，也没有规定说<strong>所有</strong>的状态都必须放到 Redux store 中。如果你想知道什么时候使用 store 存放状态，只要问自己：</p>
<blockquote>
<p><strong>组件卸载后，这个状态还需要存在吗？</strong></p>
</blockquote>
<p>如果不需要，很可能采用组件自身的 state 存储状态更合适。对于需要保存在服务器，或者跨组件（各组件独立加载和卸载）共享的状态而言，Redux 很可能是更好的选择。</p>
<p>有时候 Redux 很适用于易变的状态。特别是状态需要随着 store 中状态的改变而改变时，把它存放在 store 中可能更容易一些。对于我们的应用而言，当我们创建一个笔记时，我们需要把 <code>openNoteId</code> 设置为新的笔记 id。在组件中做这件事很笨拙，因为我们需要在 <code>componentWillReceiveProps</code> 中监控 store 状态的变化。我并不是说这是错的，只是这样很笨拙。所以对于我们的应用，我们将把 <code>openNoteId</code> 保存在 store 状态中（在真实的应用中，我们可能还需要用到路由。后文也简单介绍了使用路由的情况）。</p>
<p>另一个需要把易变状态放在 store 中的原因是可能是为了更容易从 Redux 开发者工具中访问它。通过 Redux 开发工具可以更容易的查看 store 中存储的数据，同时还可以使用状态回退之类的有趣的功能。从组件内部状态开始，再切换到 store 状态是很容易的。只要提供一个容器组件来将本地状态进行包装即可，就像用 store 来包装全局状态一样。</p>
<p>那么，我们来修改我们的 reducer 来处理易变状态吧：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> OPEN_NOTE = <span class="string">&#x27;OPEN_NOTE&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> CLOSE_NOTE = <span class="string">&#x27;CLOSE_NOTE&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> initialState = &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  openNoteId: <span class="literal">null</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> reducer = <span class="function">(<span class="params">state = initialState, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> CREATE_NOTE: &#123;</span><br><span class="line">      <span class="keyword">const</span> id = state.nextNoteId;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        openNoteId: id,</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">case</span> OPEN_NOTE: &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        openNoteId: action.id</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> CLOSE_NOTE: &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        openNoteId: <span class="literal">null</span></span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="手动组装起来"><a href="#手动组装起来" class="headerlink" title="手动组装起来"></a>手动组装起来</h2><p>好了，现在我们可以把整个东西组装起来。我们不会修改现有的组件。我们将会创建新的容器组件，从 store 获取状态并传递给 <code>NoteApp</code>：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NoteAppContainer</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    <span class="built_in">this</span>.state = props.store.getState();</span><br><span class="line">    <span class="built_in">this</span>.onAddNote = <span class="built_in">this</span>.onAddNote.bind(<span class="built_in">this</span>);</span><br><span class="line">    <span class="built_in">this</span>.onChangeNote = <span class="built_in">this</span>.onChangeNote.bind(<span class="built_in">this</span>);</span><br><span class="line">    <span class="built_in">this</span>.onOpenNote = <span class="built_in">this</span>.onOpenNote.bind(<span class="built_in">this</span>);</span><br><span class="line">    <span class="built_in">this</span>.onCloseNote = <span class="built_in">this</span>.onCloseNote.bind(<span class="built_in">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">componentWillMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.unsubscribe = <span class="built_in">this</span>.props.store.subscribe(<span class="function">() =&gt;</span></span><br><span class="line">      <span class="built_in">this</span>.setState(<span class="built_in">this</span>.props.store.getState())</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">componentWillUnmount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.unsubscribe();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">onAddNote</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.props.store.dispatch(&#123;</span><br><span class="line">      type: CREATE_NOTE</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">onChangeNote</span>(<span class="params">id, content</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.props.store.dispatch(&#123;</span><br><span class="line">      type: UPDATE_NOTE,</span><br><span class="line">      id,</span><br><span class="line">      content</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">onOpenNote</span>(<span class="params">id</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.props.store.dispatch(&#123;</span><br><span class="line">      type: OPEN_NOTE,</span><br><span class="line">      id</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">onCloseNote</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.props.store.dispatch(&#123;</span><br><span class="line">      type: CLOSE_NOTE</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;NoteApp</span><br><span class="line">        &#123;...this.state&#125;</span><br><span class="line">        onAddNote=&#123;<span class="built_in">this</span>.onAddNote&#125;</span><br><span class="line">        onChangeNote=&#123;<span class="built_in">this</span>.onChangeNote&#125;</span><br><span class="line">        onOpenNote=&#123;<span class="built_in">this</span>.onOpenNote&#125;</span><br><span class="line">        onCloseNote=&#123;<span class="built_in">this</span>.onCloseNote&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">  &lt;NoteAppContainer store=&#123;store&#125;/&gt;,</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">&#x27;root&#x27;</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>哈哈，可以了！<a target="_blank" rel="noopener" href="https://jsfiddle.net/justindeal/8bL9tL0z/23/">在 JSFiddle 试试这个应用</a></p>
<p>现在应用通过派发 action 来使得 reducer 更新 store 存储的状态数据，同时使用订阅确保了视图渲染的数据和 store 状态数据保持同步。如果遇到状态数据异常，我们不再需要检查组件本身，只需要检查触发的 actions 和 reducer 即可。</p>
<h2 id="Provider-和-Connect"><a href="#Provider-和-Connect" class="headerlink" title="Provider 和 Connect"></a>Provider 和 Connect</h2><p>好了，所有东西都能用了。但是…还有些问题。</p>
<ol>
<li>绑定操作看起来是命令式的。</li>
<li>容器组件中有很多重复代码。</li>
<li>每次把 store 绑定到组件时，需要使用全局 <code>store</code> 对象。否则，我们就需要将 <code>store</code> 传遍整个组件树。或者我们要在顶部节点绑定一次，然后把<strong>所有东西</strong>通过树传递下去。这在大型应用中可不太好。</li>
</ol>
<p>所以我们需要 React Redux 中提供的 <code>Provider</code> 和 <code>connect</code>。首先，来创建一个 <code>Provider</code> 组件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Provider</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">getChildContext</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      store: <span class="built_in">this</span>.props.store</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.props.children;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Provider.childContextTypes = &#123;</span><br><span class="line">  store: PropTypes.object</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>代码很简单，<code>Provider</code> 组件使用 React 的 <a target="_blank" rel="noopener" href="https://facebook.github.io/react/docs/context.html">context 特性</a> 来把 <code>store</code> 转变成 context 属性。Context 是一种从顶层组件向底层组件传递信息的方式，它不需要中间的组件显式传递信息。总的来说，你应该避免使用 context，因为 <a target="_blank" rel="noopener" href="https://facebook.github.io/react/docs/context.html#why-not-to-use-context">React 文档</a> 这样说：</p>
<blockquote>
<p><strong>如果你想要你的应用稳定，不要使用 context。这是个试验 API，并可能在未来的 React 版本中被放弃。</strong></p>
</blockquote>
<p>这就是我们自己使用代码实现而不直接使用 context 的原因。我们把这个试验 API 封装起来，这样如果它变了，我们可以改变自己的实现，而不需要开发者修改代码。</p>
<p>所以我们需要一种方式把 context 转化成 props。这就是 <code>connect</code> 的作用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> connect = (</span><br><span class="line">  mapStateToProps = <span class="function">() =&gt;</span> (&#123;&#125;),</span><br><span class="line">  mapDispatchToProps = <span class="function">() =&gt;</span> (&#123;&#125;)</span><br><span class="line">) =&gt; <span class="function"><span class="params">Component</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Connected</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">onStoreOrPropsChange</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123;store&#125; = <span class="built_in">this</span>.context;</span><br><span class="line">      <span class="keyword">const</span> state = store.getState();</span><br><span class="line">      <span class="keyword">const</span> stateProps = mapStateToProps(state, props);</span><br><span class="line">      <span class="keyword">const</span> dispatchProps = mapDispatchToProps(store.dispatch, props);</span><br><span class="line">      <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">        ...stateProps,</span><br><span class="line">        ...dispatchProps</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">componentWillMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123;store&#125; = <span class="built_in">this</span>.context;</span><br><span class="line">      <span class="built_in">this</span>.onStoreOrPropsChange(<span class="built_in">this</span>.props);</span><br><span class="line">      <span class="built_in">this</span>.unsubscribe = store.subscribe(<span class="function">() =&gt;</span> <span class="built_in">this</span>.onStoreOrPropsChange(<span class="built_in">this</span>.props));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">componentWillReceiveProps</span>(<span class="params">nextProps</span>)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.onStoreOrPropsChange(nextProps);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">componentWillUnmount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.unsubscribe();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Component</span> &#123;<span class="attr">...this.props</span>&#125; &#123;<span class="attr">...this.state</span>&#125;/&gt;</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Connected.contextTypes = &#123;</span><br><span class="line">    store: PropTypes.object</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Connected;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这有一点点复杂。说实话，和真正的实现相比，我们偷懒了<strong>很多</strong>（我们将在本文结尾的性能一节中讨论），但已经和真正的 Redux 的大概原理很接近了。<code>connect</code> 是一个<a target="_blank" rel="noopener" href="https://facebook.github.io/react/docs/higher-order-components.html">高阶组件</a>，实际上它更像是高阶函数，它接收两个函数，并返回一个以组件为输入、新的组件为输出的函数。这个组件订阅 store，并且在发生改变时更新你的组件的 props。开始使用这个 <code>connect</code> 吧，它会变得更实用的。</p>
<h2 id="自动组装"><a href="#自动组装" class="headerlink" title="自动组装"></a>自动组装</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mapStateToProps = <span class="function"><span class="params">state</span> =&gt;</span> (&#123;</span><br><span class="line">  notes: state.notes,</span><br><span class="line">  openNoteId: state.openNoteId</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function"><span class="params">dispatch</span> =&gt;</span> (&#123;</span><br><span class="line">  onAddNote: <span class="function">() =&gt;</span> dispatch(&#123;</span><br><span class="line">    type: CREATE_NOTE</span><br><span class="line">  &#125;),</span><br><span class="line">  onChangeNote: <span class="function">(<span class="params">id, content</span>) =&gt;</span> dispatch(&#123;</span><br><span class="line">    type: UPDATE_NOTE,</span><br><span class="line">    id,</span><br><span class="line">    content</span><br><span class="line">  &#125;),</span><br><span class="line">  onOpenNote: <span class="function"><span class="params">id</span> =&gt;</span> dispatch(&#123;</span><br><span class="line">    type: OPEN_NOTE,</span><br><span class="line">    id</span><br><span class="line">  &#125;),</span><br><span class="line">  onCloseNote: <span class="function">() =&gt;</span> dispatch(&#123;</span><br><span class="line">    type: CLOSE_NOTE</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> NoteAppContainer = connect(</span><br><span class="line">  mapStateToProps,</span><br><span class="line">  mapDispatchToProps</span><br><span class="line">)(NoteApp);</span><br></pre></td></tr></table></figure>
<p>嘿，看上去好多了！</p>
<p>传给 <code>connect</code> 的首个函数（<code>mapStateToProps</code>）从我们的 <code>store</code> 中获取当前的 <code>state</code> 并返回一些 props。第二个传给 <code>connect</code> 的函数（<code>mapDispatchToProps</code>）会获取我们 <code>store</code> 的 <code>dispatch</code> 方法，并返回一些 props。<code>connect</code> 给我们返回了一个新的函数，把我们的组件 <code>NoteApp</code> 传给这个函数，会得到一个新的组件，它将会自动获取所有这些 props（和我们额外传入的部分）。</p>
<p>现在我们需要使用我们的 <code>Provider</code> 组件，以使得 <code>connect</code> 不必把 store 放在 <code>context</code> 中。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ReactDOM.render(</span><br><span class="line">  &lt;Provider store=&#123;store&#125;&gt;</span><br><span class="line">    &lt;NoteAppContainer/&gt;</span><br><span class="line">  &lt;/Provider&gt;,</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">&#x27;root&#x27;</span>)</span><br><span class="line">);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>很好！我们的 <code>store</code> 被在顶部传入一次，然后使用 <code>connect</code> 接收 <code>store</code> 来完成所有的工作（声明式编程万岁！）。<a target="_blank" rel="noopener" href="https://jsfiddle.net/justindeal/srnf5n20/10/"><strong>这是我们用 <code>Provider</code> 和 <code>connect</code> 整理好的应用</strong></a></p>
<h2 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h2><p>现在我们已经写了一些很实用的东西，但还缺了一块：在某些环节中，我们需要和服务器通信。现在我们的 action 是同步的，该如何发出<strong>异步</strong> 的 action 呢？我们可以在组件中获取数据，但是这有一些问题：</p>
<ol>
<li>Redux（除了 <code>Provider</code> 和 <code>connect</code>）并不是专用于 React 的。最好有一个 Redux 解决方案。</li>
<li>在拉取数据时，我们有时候需要访问状态。我们并不想把状态传递得到处都是。所以我们想要写一个类似于 <code>connect</code> 的东西来获取数据。</li>
<li>我们在测试涉及到数据获取的状态变化时，必须要通过组件来测试。我们应该尽量把数据获取解耦。</li>
<li>又有一些工具不能用了。</li>
</ol>
<p>Redux 是同步的，我们应该怎么做呢？把一些东西放在 dispatch 和改变 store 状态的操作之间。这就是中间件。</p>
<p>首先，我们需要一种把中间件传给 store 的方式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> createStore = <span class="function">(<span class="params">reducer, middleware</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> state;</span><br><span class="line">  <span class="keyword">const</span> subscribers = [];</span><br><span class="line">  <span class="keyword">const</span> coreDispatch = <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">    validateAction(action);</span><br><span class="line">    state = reducer(state, action);</span><br><span class="line">    subscribers.forEach(<span class="function"><span class="params">handler</span> =&gt;</span> handler());</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">const</span> getState = <span class="function">() =&gt;</span> state;</span><br><span class="line">  <span class="keyword">const</span> store = &#123;</span><br><span class="line">    dispatch: coreDispatch,</span><br><span class="line">    getState,</span><br><span class="line">    subscribe: <span class="function"><span class="params">handler</span> =&gt;</span> &#123;</span><br><span class="line">      subscribers.push(handler);</span><br><span class="line">      <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> index = subscribers.indexOf(handler)</span><br><span class="line">        <span class="keyword">if</span> (index &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          subscribers.splice(index, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">if</span> (middleware) &#123;</span><br><span class="line">    <span class="keyword">const</span> dispatch = <span class="function"><span class="params">action</span> =&gt;</span> store.dispatch(action);</span><br><span class="line">    store.dispatch = middleware(&#123;</span><br><span class="line">      dispatch,</span><br><span class="line">      getState</span><br><span class="line">    &#125;)(coreDispatch);</span><br><span class="line">  &#125;</span><br><span class="line">  coreDispatch(&#123;<span class="attr">type</span>: <span class="string">&#x27;@@redux/INIT&#x27;</span>&#125;);</span><br><span class="line">  <span class="keyword">return</span> store;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>变得复杂了一些。重要的是最后的 <code>if</code> 语句：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (middleware) &#123;</span><br><span class="line">  <span class="keyword">const</span> dispatch = <span class="function"><span class="params">action</span> =&gt;</span> store.dispatch(action);</span><br><span class="line">  store.dispatch = middleware(&#123;</span><br><span class="line">    dispatch,</span><br><span class="line">    getState</span><br><span class="line">  &#125;)(coreDispatch);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们了创建一个”重新派发 action“的函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> dispatch = <span class="function"><span class="params">action</span> =&gt;</span> store.dispatch(action);</span><br></pre></td></tr></table></figure>
<p>如果中间件决定要发出一个新的 action，这个 action 将会通过中间件传递下去。我们需要创建这个函数，因为我们需要修改 store 的 <code>dispatch</code> 方法。（这也另一个用可变对象简化问题的例子，我们开发 Redux 时可以破坏规则，只要它能够帮助开发者遵守规则。<code>^_^</code>）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">store.dispatch = middleware(&#123;</span><br><span class="line">  dispatch,</span><br><span class="line">  getState</span><br><span class="line">&#125;)(coreDispatch);</span><br></pre></td></tr></table></figure>
<p>上面的代码调用了中间件，传给它一个能进行“re-dispatch”的函数和 <code>getState</code> 的函数。这个中间件需要返回一个新的函数，拥有用来接收调用下一个 dispatch 函数的能力（原始的 dispatch 函数）。如果你读到这里觉得头晕了，不要担心。创建和使用中间件实际上是很容易的。</p>
<p>Okay，我们来创建一个延迟一秒再 dispatch 的中间件。它没有实际用处，但能够说明异步的原理：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> delayMiddleware = <span class="function">() =&gt;</span> <span class="function"><span class="params">next</span> =&gt;</span> <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    next(action);</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这个函数的签名就看起来很傻，但是能够嵌入我们之前创建的拼图中。它是一个函数，返回一个接受下一个 dispatch 函数的函数，这个函数接受 action。看起来似乎 Redux 在疯狂使用箭头函数，但这是有原因的，我们将很快说明。</p>
<p>现在，我们开始在 store 中使用这个中间件吧。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = createStore(reducer, delayMiddleware);</span><br></pre></td></tr></table></figure>
<p>哈，我们把我们的 app 变慢了！这可不妙。但是我们有异步操作了！请试一试<a target="_blank" rel="noopener" href="https://jsfiddle.net/justindeal/56uf0uy7/7/">这个糟糕的应用</a>，打字延时显得非常可笑。</p>
<p>调整 <code>setTimeout</code> 时间可以把它变得更糟糕，或更好些。</p>
<h2 id="组装中间件"><a href="#组装中间件" class="headerlink" title="组装中间件"></a>组装中间件</h2><p>来写一个更有用的中间件，用于记录日志吧：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loggingMiddleware = <span class="function">(<span class="params">&#123;getState&#125;</span>) =&gt;</span> <span class="function"><span class="params">next</span> =&gt;</span> <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.info(<span class="string">&#x27;before&#x27;</span>, getState());</span><br><span class="line">  <span class="built_in">console</span>.info(<span class="string">&#x27;action&#x27;</span>, action);</span><br><span class="line">  <span class="keyword">const</span> result = next(action);</span><br><span class="line">  <span class="built_in">console</span>.info(<span class="string">&#x27;after&#x27;</span>, getState());</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这就很有用了。我们把它加入我们的 store 中。但是我们的 store 只能接收一个中间件函数，因此需要一种方式来组装我们的中间件。所以，我们需要一种方法，来把很多中间件函数变成一个中间件函数。来写 <code>applyMiddleware</code> 吧：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> applyMiddleware = <span class="function">(<span class="params">...middlewares</span>) =&gt;</span> <span class="function"><span class="params">store</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (middlewares.length === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">dispatch</span> =&gt;</span> dispatch;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (middlewares.length === <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> middlewares[<span class="number">0</span>](store);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> boundMiddlewares = middlewares.map(<span class="function"><span class="params">middleware</span> =&gt;</span></span><br><span class="line">    middleware(store)</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">return</span> boundMiddlewares.reduce(<span class="function">(<span class="params">a, b</span>) =&gt;</span></span><br><span class="line">    next =&gt; a(b(next))</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这不是个优雅的函数，但你应该可以跟得上。首先需要注意的是它接收一个中间件的列表，并返回一个中间件函数。这个新的中间件函数和之前的中间件有同样的签名。它接收一个 store（只包含新的派发 action 的 <code>dispatch</code> 和 <code>getState</code> 方法，不是整个 store）并返回另一个函数。对于这个函数：</p>
<ol>
<li>如果我们没有中间件，返回和原来一样的函数。基本上只是一个什么都不做的中间件（很蠢，但我们只是防止人们搞破坏）。</li>
<li>如果我们有一个中间件，直接返回这个中间件函数（也很蠢，只是做了个搬运工而已）。</li>
<li>我们把所有中间件绑定在我们假的 store 上（终于有趣起来了）。</li>
<li>我们把这些函数一个个绑定到下一个 dispatch 函数上。这就是我们的中间件有这么多箭头的原因。我们得到了这么一个函数：能够接收 action，并不断调用下一个 dispatch 函数直至抵达最原始的 dispatch 函数。</li>
</ol>
<p>好了，现在我们可以按预期使用所有的中间件了：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = createStore(reducer, applyMiddleware(</span><br><span class="line">  delayMiddleware,</span><br><span class="line">  loggingMiddleware</span><br><span class="line">));</span><br></pre></td></tr></table></figure>
<p>现在我们的 Redux 实现可以做所有的事了！<a target="_blank" rel="noopener" href="https://jsfiddle.net/justindeal/3ukd4mL7/52/">试试看</a>！</p>
<p>在浏览器中打开控制台，可以看到日志中间件发挥作用了。</p>
<h2 id="Thunk-中间件"><a href="#Thunk-中间件" class="headerlink" title="Thunk 中间件"></a>Thunk 中间件</h2><p>我们来做些真的异步操作吧。在此介绍一种“thunk”中间件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> thunkMiddleware = <span class="function">(<span class="params">&#123;dispatch, getState&#125;</span>) =&gt;</span> <span class="function"><span class="params">next</span> =&gt;</span> <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> action === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> action(dispatch, getState);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> next(action);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>“Thunk”真的只是“函数”的另一个名称，但是它通常意味着“封装了一些未来处理的工作的函数”。如果我们加入 <code>thunkMiddleware</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = createStore(reducer, applyMiddleware(</span><br><span class="line">  thunkMiddleware,</span><br><span class="line">  loggingMiddleware</span><br><span class="line">));</span><br></pre></td></tr></table></figure>
<p>现在我们可以这样做：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">store.dispatch(<span class="function">(<span class="params">&#123;getState, dispatch&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 从 state 中取数据</span></span><br><span class="line">  <span class="keyword">const</span> someId = getState().someId;</span><br><span class="line">  <span class="comment">// 根据获取到的数据从服务端拉取数据</span></span><br><span class="line">  fetchSomething(someId)</span><br><span class="line">    .then(<span class="function">(<span class="params">something</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 任何时候都可以派发 action</span></span><br><span class="line">      dispatch(&#123;</span><br><span class="line">        type: <span class="string">&#x27;someAction&#x27;</span>,</span><br><span class="line">        something</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Thunk 中间件是一柄大锤，我们可以把任何东西从 state 中拉出来，并在任何时候把任何 action 派发出去。这十分方便灵活，但随着你的 app 变得越来越大，它<strong>可能</strong>变得危险。但在这里还挺好用的。我们用它来做一些异步操作吧。</p>
<p>首先，创建一个假的 API：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> createFakeApi = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> _id = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">const</span> createNote = <span class="function">() =&gt;</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    _id++</span><br><span class="line">    resolve(&#123;</span><br><span class="line">      id: <span class="string">`<span class="subst">$&#123;_id&#125;</span>`</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;, <span class="number">1000</span>));</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    createNote</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> api = createFakeApi()</span><br></pre></td></tr></table></figure>
<p>这个 API 只支持一个创建笔记的方法，并返回这个笔记的 id。因为我们从服务端获取 id，我们需要进一步改动我们的 reducer：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> initialState = &#123;</span><br><span class="line">  notes: &#123;&#125;,</span><br><span class="line">  openNoteId: <span class="literal">null</span>,</span><br><span class="line">  isLoading: <span class="literal">false</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> reducer = <span class="function">(<span class="params">state = initialState, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> CREATE_NOTE: &#123;</span><br><span class="line">      <span class="keyword">if</span> (!action.id) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          ...state,</span><br><span class="line">          isLoading: <span class="literal">true</span></span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> newNote = &#123;</span><br><span class="line">        id: action.id,</span><br><span class="line">        content: <span class="string">&#x27;&#x27;</span></span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        isLoading: <span class="literal">false</span>,</span><br><span class="line">        openNoteId: action.id,</span><br><span class="line">        notes: &#123;</span><br><span class="line">          ...state.notes,</span><br><span class="line">          [action.id]: newNote</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这里，我们在使用 <code>CREATE_NOTE</code> action 来设置加载状态，以及在 store 中创建笔记。我们只用<code>id</code> 属性的存在与否来标记这种区别。你可能需要使用不同的 action，但 Redux 并不关心你使用什么。如果你想要一些规范，可以看看 <a target="_blank" rel="noopener" href="https://github.com/acdlite/flux-standard-action?utm_source=zapier.com&amp;utm_medium=referral&amp;utm_campaign=zapier">Flux Standard Actions</a>。</p>
<p>现在，让我们修改 <code>mapDispatchToProps</code> 来发出 thunk 吧：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function"><span class="params">dispatch</span> =&gt;</span> (&#123;</span><br><span class="line">  onAddNote: <span class="function">() =&gt;</span> dispatch(</span><br><span class="line">    (dispatch) =&gt; &#123;</span><br><span class="line">      dispatch(&#123;</span><br><span class="line">        type: CREATE_NOTE</span><br><span class="line">      &#125;);</span><br><span class="line">      api.createNote()</span><br><span class="line">        .then(<span class="function">(<span class="params">&#123;id&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">          dispatch(&#123;</span><br><span class="line">            type: CREATE_NOTE,</span><br><span class="line">            id</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  ),</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>我们的应用在执行异步操作了！<a target="_blank" rel="noopener" href="https://jsfiddle.net/justindeal/o27j5zs1/8/">试试看</a>！</p>
<p>但等等… 除了给我们的组件添加一些丑陋的代码以外，我们还发明了中间件来把这些代码清理出去。但现在又放回去了。如果我们创建了一些定制的 api 中间件而不是使用 thunk，我们就可以避免这种情况。哪怕是使用 thunk 中间件，我们也可以把代码变得更像声明式。</p>
<h2 id="Action-创建器"><a href="#Action-创建器" class="headerlink" title="Action 创建器"></a>Action 创建器</h2><p>我们可以把在组件中发出 thunk 的操作抽象出来，放进一个函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> createNote = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">    dispatch(&#123;</span><br><span class="line">      type: CREATE_NOTE</span><br><span class="line">    &#125;);</span><br><span class="line">    api.createNote()</span><br><span class="line">      .then(<span class="function">(<span class="params">&#123;id&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">        dispatch(&#123;</span><br><span class="line">          type: CREATE_NOTE,</span><br><span class="line">          id</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>上面的代码发明了一个 action 创建器。这不是什么奇特的东西，只是一个返回 action 的函数。它可以：</p>
<ol>
<li>把我们的新 thunk action 等丑陋的 action 抽象出来。</li>
<li>如果多个组件使用同样的 action，可以帮助你实现 DRY 原则。</li>
<li>让我们把创建 action 的操作抽象出来，使我们的组件更简洁。</li>
</ol>
<p>我们可以早些创建 action 创建器，但是并没有什么理由这样做。我们的应用很简单，所以不需要重复同样的 action。我们的 action 很简单，已经足够简洁和声明式了。</p>
<p>来使用 action 创建器修改一下我们的 <code>mapDispatchToProps</code>吧：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function"><span class="params">dispatch</span> =&gt;</span> (&#123;</span><br><span class="line">  onAddNote: <span class="function">() =&gt;</span> dispatch(createNote()),</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这样就好多了！<a target="_blank" rel="noopener" href="https://jsfiddle.net/justindeal/5j3can1z/171/">这是我们最终的应用</a>。</p>
<h2 id="就这样！"><a href="#就这样！" class="headerlink" title="就这样！"></a>就这样！</h2><p>你自己写了一个 Redux！看起来这篇文章写了很多代码，但是主要是我们的 reducer 和组件。我们实际的 Redux 实现还不到 <a target="_blank" rel="noopener" href="https://gist.githubusercontent.com/jdeal/c224026df3bae5803fd9e58cbbd4a60b/raw/623150cb62a7076e78904881b61d4c948639abe8/mini-redux.js">140 行代码</a>，包括了我们的 thunk 和日志中间件、空行和注释！</p>
<p>真实的 Redux 和真实的应用比这复杂一些。后文中我们将讨论其中一些没讲到的情况，如果你觉得自己掉进 Redux 的坑里了，但愿这能给你带来一些希望。</p>
<h2 id="遗留事项"><a href="#遗留事项" class="headerlink" title="遗留事项"></a>遗留事项</h2><h3 id="性能"><a href="#性能" class="headerlink" title="性能"></a>性能</h3><p>我们的实现所缺少的是，监听特定属性是否真的改变了的能力。对于我们的示例应用而言，这并不要紧，因为每个状态变化都造成了属性的改变。但对于有很多 <code>mapStateToProps</code> 函数的大型应用而言，我们只想要在组件真的接收新属性时更新。要扩展我们的 <code>connect</code> 函数来实现这一点是很容易的。我们只需要在调用 <code>setState</code> 时比较前后的数据即可。我们需要更聪明地使用 <code>mapDispatchToProps</code>。注意，我们每次都在创建新的函数。真正的 React Redux 库会检查函数的参数，看看它是否依赖<code>属性</code>。这样，如果属性没有真的改变，就不需要再做一次映射。</p>
<p>你也需要注意，当我们在属性或者 store 状态改变时，会调用我们的函数。这些改变可能会瞬间同时发生，从而浪费一些性能。React Redux 优化了这一点，也优化了很多其他东西。</p>
<p>除此之外，对于更大的应用，我们需要考虑选择器的性能。比如，如果我们过滤一系列的笔记，我们可不想不停重复计算这个列表。为此，我们需要使用例如 <a target="_blank" rel="noopener" href="https://github.com/reactjs/reselect?utm_source=zapier.com&amp;utm_medium=referral&amp;utm_campaign=zapier">reselect</a> 或者其它的技术来缓存结果。</p>
<h3 id="冻结状态"><a href="#冻结状态" class="headerlink" title="冻结状态"></a>冻结状态</h3><p>如果你使用原始 JS 数据结构（而不是像 Immutable.js 这样的东西），那么我遗漏的一个很重要的细节是在开发时冻结 reducer 状态。因为这是 JavaScript，没有什么阻止你在从 store 中获取状态之后改变它。你可以在 <code>render</code> 方法或者别的任何东西中改变它。这会造成非常糟糕的结果，并且毁坏一些正在通过 Redux 加入的可预见性。我是这样做的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> deepFreeze <span class="keyword">from</span> <span class="string">&#x27;deep-freeze&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> reducer <span class="keyword">from</span> <span class="string">&#x27;your-reducer&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> frozenReducer = process.env.NODE_ENV === <span class="string">&#x27;production&#x27;</span> ? reducer : (</span><br><span class="line">  (...args) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> state = reducer(...args);</span><br><span class="line">    <span class="keyword">return</span> freezeState(state);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>这创建了一个冻结了结果的 reducer。这样，如果你想要改变组件中的 store 状态，它将会在开发环境报错。过一段时间，你将能够避免这些错误。但如果你新接触不可变数据，这可能是最容易的练习方式了，对于你和你的团队来说都是如此。</p>
<h3 id="服务端渲染"><a href="#服务端渲染" class="headerlink" title="服务端渲染"></a>服务端渲染</h3><p>除了性能以外，我们还在我们的 <code>connect</code> 实现上偷了懒，忽略了服务端渲染。<code>componentWillMount</code> 可以在服务端被调用，但是我们不想在服务端设置监听。Redux 使用 <code>componentDidMount</code> 和一些其他技巧来使它在浏览器中正常工作。</p>
<h3 id="Store-增强"><a href="#Store-增强" class="headerlink" title="Store 增强"></a>Store 增强</h3><p>我们并没有写几个高阶函数，这儿就有一个遗漏的：“store 增强器”是一个高阶函数，接收一个 store 创建器并返回一个“增强版”的 store 创建器。这不是一个常见的操作，但它可以被用来创造 Redux 开发者工具之类的东西。<strong>真正的</strong> <a target="_blank" rel="noopener" href="https://github.com/reactjs/redux/blob/4d8700c9631b152f0dff384d528a6c7f74024418/src/applyMiddleware.js?utm_source=zapier.com&amp;utm_medium=referral&amp;utm_campaign=zapier"><code>applyMidleware</code> 实现</a> 就是一个 store 增强器。</p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>这个 Redux 的实现都没有进行任何测试。因此无论如何，请不要在任何实际的产品中使用这个实现！这只是在本文中用于说明 Redux 原理的！</p>
<h3 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h3><p>这款笔记应用目前是将数据保存在以数字作为 key 的对象中。这意味着每一个 JS 引擎都会按照创建的顺序来给它们排序。如果我们的服务器返回 GUID 或者其它未排序的主键，我们将很难排序。我们不想把笔记存放在数组中，因为要通过 id 获取特定笔记就不容易了。所以对于真实应用而言，我们可能需要用数组存放排好序的 id。另外，如果用 <code>reselect</code> 来缓存 <code>find</code> 操作结果的话，也可以尝试使用数组。</p>
<h3 id="Action-创建器的副作用"><a href="#Action-创建器的副作用" class="headerlink" title="Action 创建器的副作用"></a>Action 创建器的副作用</h3><p>有时候，你可能会想要创建一些这样的中间件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">store.dispatch(fetch(<span class="string">&#x27;/something&#x27;</span>));</span><br></pre></td></tr></table></figure>
<p>别这样做，一个返回了 promise 的函数实际上已经开始运行了（除非它是个不正常的延迟 promise）。这也意味着我们无法用任何中间件来处理这个 action。比如，我们就不能使用节流中间件。另外我们也不能正常使用回放，因为这需要关闭 dispatch 函数。但是任何调用这个 <code>dispatch</code> 的代码都已经完成了工作，所以不能把它停掉。</p>
<p>确保你的 action 是对副作用的一种描述，而不是副作用本身。Thunk 是不透明的，不是最好的描述，但是它们也是对副作用的描述而不是副作用本身。</p>
<h3 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h3><p>路由可能会很奇怪，因为浏览器持有当前位置的一些状态，还有一些用于改变位置的方法。你一旦开始使用 Redux，就可能想要把路由状态放在 Redux store 中。我就是这样做的，所以我创建了一个<a target="_blank" rel="noopener" href="https://github.com/zapier/redux-router-kit?utm_source=zapier.com&amp;utm_medium=referral&amp;utm_campaign=zapier">路由库</a>来做这件事。也可以使用新版本的 <a target="_blank" rel="noopener" href="https://reacttraining.com/react-router/">React 路由</a> 很酷，而且还有其它非 Redux 的路由解决方案。基本上，只要你想用，就可以找一些路由库来完成尽可能多的工作。</p>
<h3 id="其它事项"><a href="#其它事项" class="headerlink" title="其它事项"></a>其它事项</h3><p>基于 Redux，有大量中间件和工具组成的生态系统。下面罗列了一部分项目，你可以都看看，但推荐还是先熟悉基础知识！</p>
<p>你肯定会想看看 <a target="_blank" rel="noopener" href="https://github.com/zalmoxisus/redux-devtools-extension?utm_source=zapier.com&amp;utm_medium=referral&amp;utm_campaign=zapier">Redux 开发者工具扩展</a> 或者 <a target="_blank" rel="noopener" href="https://github.com/gaearon/redux-devtools?utm_source=zapier.com&amp;utm_medium=referral&amp;utm_campaign=zapier">Redux 开发者工具</a> 本身的代码。这些扩展是最简单的使用开发者工具的方式。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/evgenyrodionov/redux-logger?utm_source=zapier.com&amp;utm_medium=referral&amp;utm_campaign=zapier">Logger for Redux</a> 是一个很方便的把 action 输出到控制台的中间件。</p>
<p>如果你想要发出多个同步 action，但只触发一次重新渲染，<a target="_blank" rel="noopener" href="https://github.com/tshelburne/redux-batched-actions?utm_source=zapier.com&amp;utm_medium=referral&amp;utm_campaign=zapier">redux-batched-actions</a> 或 <a target="_blank" rel="noopener" href="https://github.com/manaflair/redux-batch?utm_source=zapier.com&amp;utm_medium=referral&amp;utm_campaign=zapier">redux-batch</a> 会有用。</p>
<p>如果异步 action 或副作用在使用 <a target="_blank" rel="noopener" href="https://github.com/gaearon/redux-thunk?utm_source=zapier.com&amp;utm_medium=referral&amp;utm_campaign=zapier">redux-thunk</a> 后看起来难以控制，而你又不想自己写中间件，你可以看看 <a target="_blank" rel="noopener" href="https://github.com/redux-saga/redux-saga?utm_source=zapier.com&amp;utm_medium=referral&amp;utm_campaign=zapier">redux-saga</a> 或 <a target="_blank" rel="noopener" href="https://github.com/jeffbski/redux-logic?utm_source=zapier.com&amp;utm_medium=referral&amp;utm_campaign=zapier">redux-logic</a>。或者，你想要继续深挖的话，<a target="_blank" rel="noopener" href="https://github.com/redux-loop/redux-loop?utm_source=zapier.com&amp;utm_medium=referral&amp;utm_campaign=zapier">redux-loop</a> 也很有趣。</p>
<p>如果你想用 GraphQL，可以看看 <a target="_blank" rel="noopener" href="http://dev.apollodata.com/">Apollo</a>，它可以和 Redux 结合在一起。</p>
<p>尽情享受吧！</p>
<hr>
<blockquote>
<p>翻译：<a target="_blank" rel="noopener" href="https://github.com/tanglie1993">tanglie1993</a>，<a target="_blank" rel="noopener" href="https://github.com/lsvih">lsvih</a><br>校对：<a target="_blank" rel="noopener" href="https://github.com/nia3y">nia3y</a>，<a target="_blank" rel="noopener" href="https://github.com/JohnieXu">JohnieXu</a><br>原文：<a target="_blank" rel="noopener" href="https://zapier.com/engineering/how-to-build-redux/">Build Yourself a Redux</a><br>掘金地址：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6923922875191656462">https://juejin.cn/post/6923922875191656462</a></p>
</blockquote>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>Written by:  </strong>lsvih
  </li>
  <li class="post-copyright-link">
      <strong>Post link: </strong>
      <a href="https://lsvih.com/2021/01/31/how-to-build-redux/" title="自己写一个 Redux">https://lsvih.com/2021/01/31/how-to-build-redux/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Translate/" rel="tag"># Translate</a>
              <a href="/tags/juejin/" rel="tag"># juejin</a>
              <a href="/tags/React/" rel="tag"># React</a>
              <a href="/tags/Redux/" rel="tag"># Redux</a>
              <a href="/tags/Frontend/" rel="tag"># Frontend</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/01/04/docker-binary-install/" rel="prev" title="安装并配置 Docker 二进制版">
                  <i class="fa fa-chevron-left"></i> 安装并配置 Docker 二进制版
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/02/01/building-a-design-system-and-a-component-library/" rel="next" title="构建设计系统和组件库">
                  构建设计系统和组件库 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>







<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备18029472号-1 </a>
  </div>

<div class="copyright">
  &copy; 2016 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lsvih</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div><script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    menuSettings: {
      zoom: "None"
    },
    showMathMenu: false,
    jax: ["input/TeX","output/CommonHTML"],
    extensions: ["tex2jax.js"],
    TeX: {
      extensions: ["AMSmath.js","AMSsymbols.js"],
      equationNumbers: {
        autoNumber: "AMS"
      }
    },
    tex2jax: {
      inlineMath: [["$", "$"],["\\(", "\\)"]],
      displayMath: [["\\[", "\\]"]]
    }
  });
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>


    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4.8.3/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4.9.2/dist/instantsearch.production.min.js"></script><script src="/js/algolia-search.js"></script>






  




  


</body>
</html>
